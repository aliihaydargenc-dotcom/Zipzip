<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HafÄ±za UstasÄ± Pro ğŸ†</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #ffd700;
            --danger: #ff6b6b;
            --success: #4ecdc4;
            --dark: #2d3436;
            --light: #f7f1e3;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Fredoka', sans-serif;
            /* 100vh yerine 100dvh kullanÄ±yoruz. d = dynamic. 
               Adres Ã§ubuÄŸu varsa ona gÃ¶re, yoksa tam ekrana gÃ¶re ayarlar. */
            height: 100dvh; 
            width: 100vw;
            overflow: hidden; /* KaydÄ±rmayÄ± tamamen kapatÄ±r */
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: white;
            position: fixed; /* EkranÄ± Ã§iviler, titremeyi engeller */
            top: 0;
            left: 0;
        }

        /* --- Background Effects --- */
        .bg-mesh {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            z-index: -1;
        }

        .floating-emoji {
            position: absolute;
            font-size: 2rem;
            opacity: 0.1;
            animation: floatUp 15s linear infinite;
            z-index: -1;
        }

        @keyframes floatUp {
            0% { transform: translateY(110vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.3; }
            90% { opacity: 0.3; }
            100% { transform: translateY(-10vh) rotate(360deg); opacity: 0; }
        }

        /* --- UI Components --- */
        .btn {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            border: none;
            padding: 12px 25px;
            border-radius: 15px;
            color: white;
            font-family: inherit;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .btn:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); }
        .btn:active { transform: translateY(-1px); }
        .btn-success { background: linear-gradient(to right, #11998e, #38ef7d); }
        .btn-danger { background: linear-gradient(to right, #cb2d3e, #ef473a); }
        .btn-warning { background: linear-gradient(to right, #f2994a, #f2c94c); color: #333; }
        .btn-icon { padding: 12px; border-radius: 50%; }

        /* --- Screens --- */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            transition: opacity 0.4s ease, transform 0.4s ease;
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95);
            overflow-y: auto; 
            z-index: 10;
        }

        .screen.active {
            opacity: 1;
            pointer-events: all;
            transform: scale(1);
            z-index: 20;
        }

        /* --- Main Menu --- */
        .main-menu { justify-content: center; }
        
        .game-logo {
            font-size: 4rem;
            margin-bottom: 10px;
            text-align: center;
            background: linear-gradient(45deg, #ffd700, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.3));
            animation: pulseTitle 3s infinite ease-in-out;
        }

        @keyframes pulseTitle { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        .player-summary {
            background: rgba(255,255,255,0.05);
            padding: 15px 30px;
            border-radius: 50px;
            margin-bottom: 40px;
            display: flex;
            gap: 20px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
        }

        .summary-item { display: flex; align-items: center; gap: 8px; font-size: 1.2rem; font-weight: 700; }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            max-width: 500px;
            width: 100%;
        }

        .menu-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            background: rgba(255,255,255,0.08);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .menu-btn:hover {
            background: rgba(255,255,255,0.15);
            border-color: var(--primary);
            transform: translateY(-5px);
        }

        .menu-btn-icon { font-size: 3rem; margin-bottom: 10px; }
        .menu-btn-text { font-size: 1.2rem; font-weight: 600; }
        
        .play-btn-large {
            grid-column: span 2;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
        }

        /* --- Modals (Shop, Stats, etc) --- */
        .modal-header {
            width: 100%;
            max-width: 800px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            margin-top: 20px;
        }

        .modal-title { font-size: 2.5rem; color: var(--accent); }
        
        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 1000px;
            padding-bottom: 50px;
        }

        /* Shop Items */
        .shop-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .shop-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 5px;
            background: var(--accent);
        }

        .shop-icon { font-size: 3.5rem; margin: 15px 0; }
        .shop-name { font-size: 1.4rem; font-weight: 700; margin-bottom: 5px; }
        .shop-desc { font-size: 0.9rem; opacity: 0.7; margin-bottom: 15px; min-height: 40px; }
        .shop-price { 
            background: rgba(0,0,0,0.3); 
            padding: 5px 15px; 
            border-radius: 20px; 
            color: var(--accent); 
            font-weight: 700; 
            margin-bottom: 15px;
        }

        /* Achievements */
        .achievement-card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            opacity: 0.5;
            filter: grayscale(1);
            transition: all 0.3s;
        }

        .achievement-card.unlocked {
            opacity: 1;
            filter: grayscale(0);
            background: linear-gradient(to right, rgba(78, 205, 196, 0.1), transparent);
            border: 1px solid rgba(78, 205, 196, 0.3);
        }

        .ach-icon { font-size: 2.5rem; min-width: 60px; text-align: center; }
        .ach-info { text-align: left; }
        .ach-title { font-weight: 700; color: var(--success); }
        .ach-desc { font-size: 0.85rem; opacity: 0.8; }

        /* Stats */
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            width: 100%;
        }

        .stat-label { font-size: 1.1rem; opacity: 0.8; }
        .stat-val { font-size: 1.3rem; font-weight: 700; color: var(--accent); }

        /* Game HUD */
       .game-hud {
            position: absolute; /* Fixed yerine absolute, body fixed olduÄŸu iÃ§in yeterli */
            top: 0;
            left: 0;
            width: 100%;
            padding: 10px;
            /* Ã‡entikli telefonlar (iPhone X ve Ã¼stÃ¼) iÃ§in yukarÄ±dan boÅŸluk bÄ±rakÄ±r */
            padding-top: max(15px, env(safe-area-inset-top)); 
            display: flex;
            justify-content: space-between; /* Biri saÄŸa biri sola */
            align-items: flex-start;
            z-index: 100;
            pointer-events: none; /* Aradaki boÅŸluklara tÄ±klanabilsin */
        }
       .hud-panel {
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            gap: 15px;
            pointer-events: auto;
            border: 1px solid rgba(255,255,255,0.1);
            /* Mobilde Ã§ok yer kaplamasÄ±n diye maksimum geniÅŸlik sÄ±nÄ±rÄ± */
            max-width: 80%; 
            overflow-x: auto; /* Ã‡ok dar ekranda taÅŸarsa kaydÄ±rÄ±labilsin */
        }
        /* 3. SAÄDAKÄ° Ã‡IKIÅ BUTONU (ArtÄ±k panelin iÃ§inde deÄŸil, karÅŸÄ±sÄ±nda) */
        #btnQuit {
            pointer-events: auto;
            background: rgba(220, 53, 69, 0.9); /* YarÄ± saydam kÄ±rmÄ±zÄ± */
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            border: none;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            margin-left: 10px; /* HUD ile arasÄ±na mesafe koyar */
            flex-shrink: 0; /* Asla bÃ¼zÃ¼ÅŸmesin */
        }
        .hud-stat { text-align: center; }
        .hud-label { font-size: 0.7rem; text-transform: uppercase; opacity: 0.7; letter-spacing: 1px; }
        .hud-value { font-size: 1.4rem; font-weight: 700; color: white; }
        .hud-value.gold { color: var(--accent); }

        .powerups-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 100;
            background: rgba(0,0,0,0.4);
            padding: 10px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
        }

        .powerup-btn {
            position: relative;
            width: 60px;
            height: 60px;
            border-radius: 15px;
            background: linear-gradient(135deg, #2d3436, #000);
            border: 2px solid #444;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .powerup-btn:not(:disabled):hover { transform: translateY(-5px); border-color: var(--accent); }
        .powerup-btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        
        .badge-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: white;
            font-size: 0.8rem;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #1a1a2e;
            font-weight: 700;
        }

        /* Game Board adjustments */
        .game-board-container {
            margin-top: 80px;
            margin-bottom: 100px;
            display: flex;
            justify-content: center;
            width: 100%;
        }
        
        /* ... Eski CSS'in game-board ve card kÄ±sÄ±mlarÄ± buraya entegre edilecek ... */
       .game-board {
            display: grid;
            gap: 10px;
            perspective: 1000px;
            /* Kart dÃ¶nerken 3D alanÄ± merkeze sabitler */
            perspective-origin: center center; 
        }
        .card {
            position: relative;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
            width: 80px; 
            height: 80px;
            /* YENÄ° EKLENENLER: */
            will-change: transform; /* TarayÄ±cÄ±ya Ã¶ncelik verdirir */
            -webkit-backface-visibility: hidden; /* Safari/iOS titremesini Ã§Ã¶zer */
            backface-visibility: hidden;
        }
        .card.flipped { transform: rotateY(180deg); }
        .card.matched { animation: matchPop 0.5s forwards; }
        .card.unmatched { animation: shake 0.5s; }
        
        @keyframes matchPop {
            0% { transform: rotateY(180deg) scale(1); }
            50% { transform: rotateY(180deg) scale(1.2); box-shadow: 0 0 30px var(--accent); }
            100% { transform: rotateY(180deg) scale(0); opacity: 0; visibility: hidden; }
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            font-size: 2.5rem;
        }
        .card-front {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: 2px solid rgba(255,255,255,0.1);
        }
        .card-front::after { content: 'â“'; font-size: 2rem; opacity: 0.7; }
        .card-back {
            background: white;
            color: #333;
            transform: rotateY(180deg);
            border: 2px solid var(--accent);
        }

        /* Settings Toggle */
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            margin-bottom: 15px;
            width: 100%;
        }
        .toggle-switch {
            width: 60px;
            height: 30px;
            background: #444;
            border-radius: 30px;
            position: relative;
            cursor: pointer;
            transition: 0.3s;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px; left: 2px;
            width: 26px; height: 26px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }
        .toggle-switch.active { background: var(--success); }
        .toggle-switch.active::after { left: 32px; }

        /* Notification Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            color: #333;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transform: translateX(150%);
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        .toast.show { transform: translateX(0); }
        .toast-icon { font-size: 1.5rem; }

        /* Mobil Dokunmatik Ä°yileÅŸtirmeleri */
        button, .card, .menu-btn, .powerup-btn, .toggle-switch {
            touch-action: manipulation; /* Ã‡ift tÄ±klama zoomunu iptal eder, tepkiyi hÄ±zlandÄ±rÄ±r */
            cursor: pointer;
        }

        /* 4. MOBÄ°L Ä°Ã‡Ä°N YAZI KÃœÃ‡ÃœLTME (SÄ±kÄ±ÅŸÄ±klÄ±ÄŸÄ± giderir) */
        @media (max-width: 480px) {
            .hud-panel {
                gap: 10px;
                padding: 5px 10px;
            }
            .hud-label {
                font-size: 0.5rem; /* YazÄ±larÄ± ufalttÄ±k */
                margin-bottom: 2px;
            }
            .hud-value {
                font-size: 1rem;
            }
            /* Ä°kon ile sayÄ±larÄ± alt alta deÄŸil yan yana yapalÄ±m mobilde yer kazanalÄ±m */
            .hud-stat {
                display: flex;
                flex-direction: column;
                align-items: center;
                min-width: 30px;
            }
            
            /* Oyun alanÄ±nÄ± biraz daha aÅŸaÄŸÄ± itelim ki panele deÄŸmesin */
            .game-board-container {
                margin-top: 100px; 
            }
        }

    </style>
</head>

<body>

    <div class="bg-mesh"></div>
    <div id="floatingContainer"></div>

    <div id="toast" class="toast">
        <span class="toast-icon">ğŸ†</span>
        <span id="toastMsg">Bildirim</span>
    </div>

    <div id="screen-menu" class="screen active main-menu">
        <h1 class="game-logo">ğŸ§  HafÄ±za UstasÄ±</h1>
        
        <div class="player-summary">
            <div class="summary-item"><span style="color:var(--accent)">ğŸ’°</span> <span id="menuCoin">0</span></div>
            <div class="summary-item"><span>â­</span> <span id="menuLevel">Lv. 1</span></div>
        </div>

        <div class="menu-grid">
            <div class="menu-btn play-btn-large" onclick="Game.start()">
                <div class="menu-btn-icon">ğŸš€</div>
                <div class="menu-btn-text">OYNA</div>
            </div>
            <div class="menu-btn" onclick="Nav.to('shop')">
                <div class="menu-btn-icon">ğŸ›’</div>
                <div class="menu-btn-text">MaÄŸaza</div>
            </div>
            <div class="menu-btn" onclick="Nav.to('stats')">
                <div class="menu-btn-icon">ğŸ“Š</div>
                <div class="menu-btn-text">Ä°statistik</div>
            </div>
            <div class="menu-btn" onclick="Nav.to('achievements')">
                <div class="menu-btn-icon">ğŸ†</div>
                <div class="menu-btn-text">BaÅŸarÄ±m</div>
            </div>
            <div class="menu-btn" onclick="Nav.to('settings')">
                <div class="menu-btn-icon">âš™ï¸</div>
                <div class="menu-btn-text">Ayarlar</div>
            </div>
        </div>
    </div>

    <div id="screen-game" class="screen">
        
        <div class="game-hud">
            <div class="hud-panel">
                <div class="hud-stat">
                    <div class="hud-label">Seviye</div>
                    <div class="hud-value" id="gameLevel">1</div>
                </div>
                <div class="hud-stat">
                    <div class="hud-label">Hamle</div>
                    <div class="hud-value" id="gameMoves">0</div>
                </div>
                <div class="hud-stat">
                    <div class="hud-label">SÃ¼re</div>
                    <div class="hud-value" id="gameTimer">--:--</div>
                </div>
                <div class="hud-stat">
                    <div class="hud-label">AltÄ±n</div>
                    <div class="hud-value gold" id="gameCoins">0</div>
                </div>
            </div>

            <button id="btnQuit" onclick="Game.quit()">âŒ</button>
        </div>

        <div class="game-board-container">
            <div id="gameBoard" class="game-board"></div>
        </div>

        <div class="powerups-container">
            <button class="powerup-btn" id="btnJoker" onclick="PowerUps.use('joker')" title="TÃ¼m kartlarÄ± gÃ¶ster">
                ğŸ‘ï¸ <div class="badge-count" id="count-joker">0</div>
            </button>
            <button class="powerup-btn" id="btnFreeze" onclick="PowerUps.use('freeze')" title="ZamanÄ± dondur">
                â„ï¸ <div class="badge-count" id="count-freeze">0</div>
            </button>
            <button class="powerup-btn" id="btnHint" onclick="PowerUps.use('hint')" title="Bir eÅŸleÅŸme gÃ¶ster">
                ğŸ’¡ <div class="badge-count" id="count-hint">0</div>
            </button>
        </div>
        
    </div> <div id="screen-shop" class="screen">
        <div class="modal-header">
            <button class="btn btn-icon" onclick="Nav.to('menu')">â¬…ï¸</button>
            <h2 class="modal-title">MaÄŸaza</h2>
            <div class="summary-item"><span style="color:var(--accent)">ğŸ’°</span> <span id="shopCoins">0</span></div>
        </div>
        <div class="content-grid" id="shopGrid">
            </div>
    </div>

    <div id="screen-achievements" class="screen">
        <div class="modal-header">
            <button class="btn btn-icon" onclick="Nav.to('menu')">â¬…ï¸</button>
            <h2 class="modal-title">BaÅŸarÄ±mlar</h2>
        </div>
        <div class="content-grid" id="achievementsGrid"></div>
    </div>

    <div id="screen-stats" class="screen">
        <div class="modal-header">
            <button class="btn btn-icon" onclick="Nav.to('menu')">â¬…ï¸</button>
            <h2 class="modal-title">Ä°statistikler</h2>
        </div>
        <div style="width:100%; max-width:600px; background:rgba(0,0,0,0.3); border-radius:20px; padding:20px;">
            <div class="stat-row">
                <span class="stat-label">Toplam Oynanan Oyun</span>
                <span class="stat-val" id="statTotalGames">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">KazanÄ±lan Zaferler</span>
                <span class="stat-val" id="statWins">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Toplam EÅŸleÅŸme</span>
                <span class="stat-val" id="statTotalMatches">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">En YÃ¼ksek Seviye</span>
                <span class="stat-val" id="statMaxLevel">1</span>
            </div>
        </div>
    </div>

    <div id="screen-settings" class="screen">
        <div class="modal-header">
            <button class="btn btn-icon" onclick="Nav.to('menu')">â¬…ï¸</button>
            <h2 class="modal-title">Ayarlar</h2>
        </div>
        <div style="width:100%; max-width:500px;">
            <div class="setting-row">
                <span>ğŸµ MÃ¼zik</span>
                <div class="toggle-switch active" id="toggleMusic" onclick="Settings.toggle('music')"></div>
            </div>
            <div class="setting-row">
                <span>ğŸ”Š Ses Efektleri</span>
                <div class="toggle-switch active" id="toggleSfx" onclick="Settings.toggle('sfx')"></div>
            </div>
            <div class="setting-row">
                <span>ğŸ—‘ï¸ Verileri SÄ±fÄ±rla</span>
                <button class="btn btn-danger" onclick="DataManager.reset()">SIFIRLA</button>
            </div>
        </div>
    </div>

    <div id="overlay-result" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:none; justify-content:center; align-items:center; z-index:999; flex-direction:column; text-align:center;">
        <h1 id="resultTitle" style="font-size:4rem; margin-bottom:20px;"></h1>
        <div id="resultStars" style="font-size:3rem; margin-bottom:20px;"></div>
        <p id="resultMsg" style="font-size:1.5rem; margin-bottom:30px; opacity:0.8;"></p>
        <div style="display:flex; gap:15px;">
            <button class="btn" onclick="Game.restartLevel()">ğŸ”„ Tekrar</button>
            <button class="btn btn-success" id="btnNextLevel" onclick="Game.nextLevel()">â¡ï¸ Sonraki</button>
            <button class="btn btn-danger" onclick="Game.quit()">ğŸ  MenÃ¼</button>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. DATA MANAGER & STATE
        // ==========================================
        const DefaultData = {
            coins: 100, // BaÅŸlangÄ±Ã§ parasÄ±
            currentLevel: 1,
            maxLevelReached: 1,
            inventory: {
                joker: 1,
                freeze: 0,
                hint: 0
            },
            stats: {
                totalGames: 0,
                wins: 0,
                totalMatches: 0
            },
            achievements: [], // 'id' listesi
            settings: {
                music: true,
                sfx: true
            }
        };

        const DataManager = {
            data: null,
            init() {
                const saved = localStorage.getItem('hafizaProV2');
                if (saved) {
                    this.data = JSON.parse(saved);
                    // Versiyon farkÄ± varsa merge et (basitÃ§e)
                    if(!this.data.inventory) this.data.inventory = DefaultData.inventory;
                } else {
                    this.data = JSON.parse(JSON.stringify(DefaultData));
                }
                this.save();
                this.updateUI();
            },
            save() {
                localStorage.setItem('hafizaProV2', JSON.stringify(this.data));
                this.updateUI();
            },
            reset() {
                if(confirm('TÃ¼m ilerlemeniz silinecek. Emin misiniz?')) {
                    localStorage.removeItem('hafizaProV2');
                    location.reload();
                }
            },
            addCoins(amount) {
                this.data.coins += amount;
                this.save();
                Toast.show(`+${amount} AltÄ±n KazandÄ±n!`, 'ğŸ’°');
            },
            spendCoins(amount) {
                if (this.data.coins >= amount) {
                    this.data.coins -= amount;
                    this.save();
                    return true;
                }
                Toast.show('Yetersiz AltÄ±n!', 'âŒ');
                return false;
            },
            updateUI() {
                // MenÃ¼ deÄŸerleri
                document.getElementById('menuCoin').innerText = this.data.coins;
                document.getElementById('menuLevel').innerText = `Lv. ${this.data.currentLevel}`;
                // Oyun iÃ§i deÄŸerler
                document.getElementById('gameCoins').innerText = this.data.coins;
                document.getElementById('shopCoins').innerText = this.data.coins;
                // Envanter
                document.getElementById('count-joker').innerText = this.data.inventory.joker;
                document.getElementById('count-freeze').innerText = this.data.inventory.freeze;
                document.getElementById('count-hint').innerText = this.data.inventory.hint;
                // Buton durumlarÄ±
                document.getElementById('btnJoker').disabled = this.data.inventory.joker <= 0;
                document.getElementById('btnFreeze').disabled = this.data.inventory.freeze <= 0;
                document.getElementById('btnHint').disabled = this.data.inventory.hint <= 0;
                
                Stats.render();
            }
        };

        // ==========================================
        // 2. CONFIGURATION & CONTENT
        // ==========================================
        const ShopItems = [
            { id: 'joker', name: 'GÃ¶zcÃ¼', icon: 'ğŸ‘ï¸', desc: 'TÃ¼m kartlarÄ± 1 saniyeliÄŸine gÃ¶sterir.', price: 50 },
            { id: 'freeze', name: 'ZamanÄ± Dondur', icon: 'â„ï¸', desc: 'SÃ¼reyi 10 saniyeliÄŸine durdurur.', price: 100 },
            { id: 'hint', name: 'Ä°pucu', icon: 'ğŸ’¡', desc: 'Bir eÅŸleÅŸmeyi otomatik olarak bulur.', price: 150 }
        ];

        const Achievements = [
            { id: 'first_win', title: 'Ä°lk AdÄ±m', desc: 'Ä°lk seviyeyi tamamla.', icon: 'ğŸ‘¶', check: (d) => d.stats.wins >= 1 },
            { id: 'rich', title: 'Hazine AvcÄ±sÄ±', desc: '500 altÄ±na sahip ol.', icon: 'ğŸ’°', check: (d) => d.coins >= 500 },
            { id: 'veteran', title: 'Veteran', desc: '50 oyun oyna.', icon: 'ğŸ–ï¸', check: (d) => d.stats.totalGames >= 50 },
            { id: 'master', title: 'HafÄ±za UstasÄ±', desc: '20. Seviyeye ulaÅŸ.', icon: 'ğŸ§ ', check: (d) => d.maxLevelReached >= 20 }
        ];

        const LevelConfig = (level) => {
            // Dinamik zorluk ayarÄ±
            let cols = 4, rows = 4, time = 0;
            if (level > 2) { cols = 4; rows = 5; }
            if (level > 5) { cols = 4; rows = 6; time = 120; }
            if (level > 10) { cols = 5; rows = 6; time = 180; }
            if (level > 15) { cols = 6; rows = 6; time = 240; }
            
            return {
                rows, cols,
                pairs: (rows * cols) / 2,
                time: time
            };
        };

        const Emojis = ['ğŸ¦', 'ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦’', 'ğŸ¦“', 'ğŸ¦Œ', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸµ', 'ğŸ', 'ğŸŒ', 'ğŸ‡', 'ğŸ“', 'ğŸ’', 'ğŸ‘', 'ğŸ', 'ğŸ¥', 'âš½', 'ğŸ€', 'ğŸˆ', 'âš¾', 'ğŸ¾', 'ğŸš€', 'ğŸ›¸', 'ğŸ¸', 'ğŸ»'];

        // ==========================================
        // 3. AUDIO SYSTEM
        // ==========================================
    // ==========================================
        // 3. AUDIO SYSTEM (DÃœZELTÄ°LMÄ°Å)
        // ==========================================
        const AudioSys = {
            ctx: null,
            init() {
                // TarayÄ±cÄ± uyumluluÄŸu iÃ§in
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!this.ctx) this.ctx = new AudioContext();
            },
            play(type) {
                if (!DataManager.data.settings.sfx) return;
                this.init();
                
                // Chrome gibi tarayÄ±cÄ±lar iÃ§in context askÄ±daysa baÅŸlat
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }

                const now = this.ctx.currentTime;

                // WIN durumu iÃ§in Ã¶zel (Ã§oklu nota)
                if (type === 'win') {
                    const notes = [523, 659, 784, 1046];
                    notes.forEach((f, i) => {
                        const o = this.ctx.createOscillator();
                        const g = this.ctx.createGain();
                        o.connect(g);
                        g.connect(this.ctx.destination);
                        o.frequency.value = f;
                        g.gain.value = 0.1;
                        
                        // Ã–nce baÅŸlat, sonra durdurmayÄ± zamanla
                        o.start(now + i * 0.15);
                        g.gain.exponentialRampToValueAtTime(0.01, now + i * 0.15 + 0.5);
                        o.stop(now + i * 0.15 + 0.5);
                    });
                    return; // Fonksiyondan Ã§Ä±k, aÅŸaÄŸÄ±daki standart sesi Ã§alma
                }

                // FLIP ve MATCH iÃ§in standart osilatÃ¶r
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);

                // Ã–NCE BAÅLAT (HatayÄ± Ã§Ã¶zen kÄ±sÄ±m burasÄ±)
                osc.start(now);

                if (type === 'flip') {
                    osc.frequency.setValueAtTime(400, now);
                    gain.gain.setValueAtTime(0.1, now);
                    // BaÅŸladÄ±ktan sonra durdurmayÄ± zamanla
                    osc.stop(now + 0.1);
                } else if (type === 'match') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(600, now);
                    osc.frequency.exponentialRampToValueAtTime(1200, now + 0.2);
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.stop(now + 0.3);
                } else {
                    // TanÄ±msÄ±z bir ses tipi gelirse hemen durdur
                    osc.stop(now);
                }
            }
        };

        // ==========================================
        // 4. GAME ENGINE
        // ==========================================
        const Game = {
            state: {
                level: 1,
                cards: [],
                flipped: [],
                matches: 0,
                moves: 0,
                timer: null,
                timeLeft: 0,
                locked: false,
                frozen: false
            },

            start() {
                this.state.level = DataManager.data.currentLevel;
                Nav.to('game');
                this.initLevel();
                DataManager.data.stats.totalGames++;
                DataManager.save();
            },

            initLevel() {
                const config = LevelConfig(this.state.level);
                this.state.matches = 0;
                this.state.moves = 0;
                this.state.flipped = [];
                this.state.locked = false;
                this.state.frozen = false;
                
                // UI GÃ¼ncelle
                document.getElementById('gameLevel').innerText = this.state.level;
                document.getElementById('gameMoves').innerText = 0;
                
                // ZamanlayÄ±cÄ±
                if (this.state.timer) clearInterval(this.state.timer);
                if (config.time > 0) {
                    this.state.timeLeft = config.time;
                    this.startTimer();
                } else {
                    document.getElementById('gameTimer').innerText = 'âˆ';
                }

                // Grid OluÅŸtur
                const board = document.getElementById('gameBoard');
                board.innerHTML = '';
                board.style.gridTemplateColumns = `repeat(${config.cols}, 1fr)`;

                // KartlarÄ± karÄ±ÅŸtÄ±r
                const selection = Emojis.sort(() => 0.5 - Math.random()).slice(0, config.pairs);
                const deck = [...selection, ...selection].sort(() => 0.5 - Math.random());
                
                this.state.cards = [];
                deck.forEach((emoji, i) => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.dataset.value = emoji;
                    card.dataset.id = i;
                    card.innerHTML = `
                        <div class="card-face card-front"></div>
                        <div class="card-face card-back">${emoji}</div>
                    `;
                    card.onclick = () => this.flip(card);
                    
                    // BoyutlandÄ±rma
                    const size = Math.min(80, (window.innerWidth - 40) / config.cols - 10);
                    card.style.width = size + 'px';
                    card.style.height = size + 'px';
                    card.style.fontSize = size * 0.5 + 'px';

                    board.appendChild(card);
                    this.state.cards.push(card);
                });

                // BaÅŸlangÄ±Ã§ animasyonu
                this.preview();
            },

            preview() {
                this.state.locked = true;
                this.state.cards.forEach(c => c.classList.add('flipped'));
                setTimeout(() => {
                    this.state.cards.forEach(c => c.classList.remove('flipped'));
                    this.state.locked = false;
                }, 1500);
            },

            flip(card) {
                if (this.state.locked || card.classList.contains('flipped') || card.classList.contains('matched')) return;
                
                AudioSys.play('flip');
                card.classList.add('flipped');
                this.state.flipped.push(card);

                if (this.state.flipped.length === 2) {
                    this.state.moves++;
                    document.getElementById('gameMoves').innerText = this.state.moves;
                    this.checkMatch();
                }
            },

            checkMatch() {
                this.state.locked = true;
                const [c1, c2] = this.state.flipped;
                const match = c1.dataset.value === c2.dataset.value;

                if (match) {
                    AudioSys.play('match');
                    setTimeout(() => {
                        c1.classList.add('matched');
                        c2.classList.add('matched');
                        this.state.matches++;
                        this.state.flipped = [];
                        this.state.locked = false;
                        
                        // AltÄ±n kazan
                        DataManager.addCoins(2);
                        DataManager.data.stats.totalMatches++;
                        
                        const config = LevelConfig(this.state.level);
                        if (this.state.matches === config.pairs) {
                            this.win();
                        }
                    }, 500);
                } else {
                    setTimeout(() => {
                        c1.classList.remove('flipped');
                        c2.classList.remove('flipped');
                        this.state.flipped = [];
                        this.state.locked = false;
                    }, 1000);
                }
            },

            startTimer() {
                this.updateTimerDisplay();
                this.state.timer = setInterval(() => {
                    if(!this.state.frozen) {
                        this.state.timeLeft--;
                        this.updateTimerDisplay();
                        if (this.state.timeLeft <= 0) {
                            clearInterval(this.state.timer);
                            this.gameOver();
                        }
                    }
                }, 1000);
            },

            updateTimerDisplay() {
                const m = Math.floor(this.state.timeLeft / 60);
                const s = this.state.timeLeft % 60;
                document.getElementById('gameTimer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            },

            win() {
                clearInterval(this.state.timer);
                AudioSys.play('win');
                
                // Ä°statistikleri gÃ¼ncelle
                DataManager.data.stats.wins++;
                if (this.state.level === DataManager.data.maxLevelReached) {
                    DataManager.data.maxLevelReached++;
                }
                
                // Seviye tamamlama bonusu
                const bonus = 20 + (this.state.level * 5);
                DataManager.addCoins(bonus);
                
                AchievementSys.check(); // BaÅŸarÄ±m kontrolÃ¼
                DataManager.save();

                // SonuÃ§ ekranÄ±
                document.getElementById('resultTitle').innerText = 'ğŸ‰ KAZANDIN!';
                document.getElementById('resultTitle').style.color = '#4ecdc4';
                document.getElementById('resultStars').innerText = 'â­â­â­';
                document.getElementById('resultMsg').innerText = `${this.state.moves} hamle yaptÄ±n ve ${bonus} altÄ±n kazandÄ±n!`;
                document.getElementById('btnNextLevel').style.display = 'inline-block';
                document.getElementById('overlay-result').style.display = 'flex';
            },

            gameOver() {
                clearInterval(this.state.timer);
                document.getElementById('resultTitle').innerText = 'â° SÃœRE DOLDU';
                document.getElementById('resultTitle').style.color = '#ff6b6b';
                document.getElementById('resultStars').innerText = 'ğŸ’”';
                document.getElementById('resultMsg').innerText = 'Tekrar dene!';
                document.getElementById('btnNextLevel').style.display = 'none';
                document.getElementById('overlay-result').style.display = 'flex';
            },

            nextLevel() {
                document.getElementById('overlay-result').style.display = 'none';
                this.state.level++;
                DataManager.data.currentLevel = this.state.level;
                DataManager.save();
                this.initLevel();
            },

            restartLevel() {
                document.getElementById('overlay-result').style.display = 'none';
                this.initLevel();
            },

            quit() {
                clearInterval(this.state.timer);
                document.getElementById('overlay-result').style.display = 'none';
                Nav.to('menu');
            }
        };

        // ==========================================
        // 5. POWER-UPS LOGIC
        // ==========================================
        const PowerUps = {
            use(type) {
                if (DataManager.data.inventory[type] > 0) {
                    DataManager.data.inventory[type]--;
                    DataManager.save();
                    
                    if (type === 'joker') {
                        Game.state.locked = true;
                        Game.state.cards.forEach(c => {
                            if (!c.classList.contains('matched')) c.classList.add('flipped');
                        });
                        setTimeout(() => {
                            Game.state.cards.forEach(c => {
                                if (!c.classList.contains('matched')) c.classList.remove('flipped');
                            });
                            Game.state.locked = false;
                        }, 1000);
                    } else if (type === 'freeze') {
                        Game.state.frozen = true;
                        document.getElementById('gameTimer').style.color = '#4ecdc4';
                        Toast.show('Zaman 10sn durduruldu!', 'â„ï¸');
                        setTimeout(() => {
                            Game.state.frozen = false;
                            document.getElementById('gameTimer').style.color = 'white';
                        }, 10000);
                    } else if (type === 'hint') {
                        const unmatched = Game.state.cards.filter(c => !c.classList.contains('matched'));
                        if (unmatched.length > 0) {
                            const first = unmatched[0];
                            const match = unmatched.find(c => c !== first && c.dataset.value === first.dataset.value);
                            first.classList.add('flipped');
                            match.classList.add('flipped');
                            setTimeout(() => {
                                first.classList.remove('flipped');
                                match.classList.remove('flipped');
                            }, 1000);
                        }
                    }
                }
            }
        };

        // ==========================================
        // 6. UI & NAVIGATION
        // ==========================================
        const Nav = {
            to(screenId) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(`screen-${screenId}`).classList.add('active');
                
                if (screenId === 'shop') Shop.render();
                if (screenId === 'achievements') AchievementSys.render();
                if (screenId === 'stats') Stats.render();
            }
        };

        const Toast = {
            show(msg, icon) {
                const el = document.getElementById('toast');
                document.getElementById('toastMsg').innerText = msg;
                document.querySelector('.toast-icon').innerText = icon || 'â„¹ï¸';
                el.classList.add('show');
                setTimeout(() => el.classList.remove('show'), 3000);
            }
        };

        const Shop = {
            render() {
                const grid = document.getElementById('shopGrid');
                grid.innerHTML = '';
                ShopItems.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'shop-card';
                    el.innerHTML = `
                        <div class="shop-icon">${item.icon}</div>
                        <div class="shop-name">${item.name}</div>
                        <div class="shop-desc">${item.desc}</div>
                        <div class="shop-price">${item.price} AltÄ±n</div>
                        <button class="btn btn-success" onclick="Shop.buy('${item.id}', ${item.price})">SatÄ±n Al</button>
                    `;
                    grid.appendChild(el);
                });
            },
            buy(itemId, price) {
                if (DataManager.spendCoins(price)) {
                    DataManager.data.inventory[itemId]++;
                    DataManager.save();
                    Toast.show('SatÄ±n alÄ±m baÅŸarÄ±lÄ±!', 'âœ…');
                }
            }
        };

        const AchievementSys = {
            check() {
                Achievements.forEach(ach => {
                    if (!DataManager.data.achievements.includes(ach.id)) {
                        if (ach.check(DataManager.data)) {
                            DataManager.data.achievements.push(ach.id);
                            Toast.show(`BaÅŸarÄ±m: ${ach.title}`, ach.icon);
                            DataManager.save();
                        }
                    }
                });
            },
            render() {
                const grid = document.getElementById('achievementsGrid');
                grid.innerHTML = '';
                Achievements.forEach(ach => {
                    const unlocked = DataManager.data.achievements.includes(ach.id);
                    const el = document.createElement('div');
                    el.className = `achievement-card ${unlocked ? 'unlocked' : ''}`;
                    el.innerHTML = `
                        <div class="ach-icon">${ach.icon}</div>
                        <div class="ach-info">
                            <div class="ach-title">${ach.title} ${unlocked ? 'âœ…' : 'ğŸ”’'}</div>
                            <div class="ach-desc">${ach.desc}</div>
                        </div>
                    `;
                    grid.appendChild(el);
                });
            }
        };

        const Stats = {
            render() {
                document.getElementById('statTotalGames').innerText = DataManager.data.stats.totalGames;
                document.getElementById('statWins').innerText = DataManager.data.stats.wins;
                document.getElementById('statTotalMatches').innerText = DataManager.data.stats.totalMatches;
                document.getElementById('statMaxLevel').innerText = DataManager.data.maxLevelReached;
            }
        };
        
        const Settings = {
            toggle(key) {
                DataManager.data.settings[key] = !DataManager.data.settings[key];
                document.getElementById(key === 'music' ? 'toggleMusic' : 'toggleSfx')
                    .classList.toggle('active', DataManager.data.settings[key]);
                DataManager.save();
            }
        };

        // --- Init ---
        window.onload = () => {
            DataManager.init();
            // Background Floating Emojis
            const container = document.getElementById('floatingContainer');
            for(let i=0; i<15; i++) {
                const el = document.createElement('div');
                el.className = 'floating-emoji';
                el.innerText = Emojis[Math.floor(Math.random() * Emojis.length)];
                el.style.left = Math.random() * 100 + '%';
                el.style.animationDelay = Math.random() * 5 + 's';
                el.style.animationDuration = (10 + Math.random() * 20) + 's';
                container.appendChild(el);
            }
            
            // Settings UI Sync
            document.getElementById('toggleMusic').classList.toggle('active', DataManager.data.settings.music);
            document.getElementById('toggleSfx').classList.toggle('active', DataManager.data.settings.sfx);
        };

    </script>
</body>
</html>
